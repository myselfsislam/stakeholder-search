<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stakeholder Search</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0a0a0b;
            --secondary-bg: #fefefe;
            --card-bg: #ffffff;
            --accent-primary: #00d4ff;
            --accent-secondary: #ff0080;
            --accent-tertiary: #00ff88;
            --business-opportunity: #ffaa00;
            --direct-connection: #00ff88;
            --indirect-connection: #ffaa00;
            --no-connection: #666666;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', 'JetBrains Mono', monospace;
            background: #f9f9f7;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .header {
            background: #404083;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 212, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 0, 128, 0.2) 0%, transparent 50%);
            color: var(--text-primary);
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 70%);
            animation: shimmer 3s ease infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            font-family: 'Space Grotesk', sans-serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
            color: #ffffff;
        }

        .header p {
            font-size: 1.3rem;
            font-weight: 400;
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            color: #ffffff;
        }

        .search-section {
            padding: 40px;
            background: #ffffff;
            border-bottom: 1px solid var(--border-color);
        }

        .search-container {
            display: flex;
            gap: 24px;
            align-items: end;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 280px;
        }

        .filter-group {
            min-width: 220px;
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'JetBrains Mono', monospace;
        }

        input[type="text"], select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
            background: var(--glass-bg);
        }

        .search-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: var(--primary-bg);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            min-height: 56px;
            font-family: 'Space Grotesk', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.4);
        }

        .results-section {
            padding: 40px;
        }

        /* Visualization Layout Wrapper */
        .visualization-wrapper {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Connection Champions Card Styles */
        .champions-card {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .champions-header {
            background: #404083;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 212, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 0, 128, 0.2) 0%, transparent 50%);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }

        .champions-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 70%);
            animation: shimmer 3s ease infinite;
        }

        .champions-title {
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .champions-content {
            padding: 24px;
        }

        .champions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .champion-card {
            background: linear-gradient(135deg, var(--card-bg), rgba(255, 255, 255, 0.05));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .champion-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2);
        }

        .champion-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .champion-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .champion-connections {
            color: var(--accent-primary);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .champion-breakdown {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .connection-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-direct {
            background: rgba(0, 255, 136, 0.2);
            color: var(--direct-connection);
            border: 1px solid var(--direct-connection);
        }

        .badge-indirect {
            background: rgba(255, 170, 0, 0.2);
            color: var(--indirect-connection);
            border: 1px solid var(--indirect-connection);
        }

        .visualization-container {
            display: flex;
            gap: 24px;
            min-height: 600px;
        }

        .visualization-panel {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .panel-header {
            background: #404083;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 212, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 0, 128, 0.2) 0%, transparent 50%);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        .panel-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 70%);
            animation: shimmer 3s ease infinite;
        }

        .panel-title {
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .control-btn {
            background: var(--glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
            min-width: 32px;
        }

        .control-btn:hover {
            background: var(--accent-primary);
            color: var(--primary-bg);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .business-opportunity-banner {
            background: linear-gradient(135deg, var(--business-opportunity) 0%, var(--accent-secondary) 100%);
            color: var(--primary-bg);
            padding: 16px 20px;
            margin: 20px;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            text-align: center;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(255, 170, 0, 0.3); }
            100% { box-shadow: 0 0 30px rgba(255, 170, 0, 0.6); }
        }

        .opportunity-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        #org-chart {
            height: 540px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .chart-zoomable {
            cursor: grab;
        }

        .chart-zoomable:active {
            cursor: grabbing;
        }

        .zoom-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--glass-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }

        #map {
            height: 540px;
            background: transparent;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.3rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.5));
        }

        .node circle.direct-connection {
            fill: var(--direct-connection);
            stroke: var(--direct-connection);
            filter: drop-shadow(0 0 12px rgba(0, 255, 136, 0.7));
        }

        .node circle.indirect-connection {
            fill: var(--indirect-connection);
            stroke: var(--indirect-connection);
            filter: drop-shadow(0 0 12px rgba(255, 170, 0, 0.7));
        }

        .node circle.no-connection {
            fill: var(--no-connection);
            stroke: var(--no-connection);
            filter: drop-shadow(0 0 8px rgba(102, 102, 102, 0.5));
        }

        .connection-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            max-width: 200px;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid;
            flex-shrink: 0;
        }

        .legend-dot.direct {
            background: var(--direct-connection);
            border-color: var(--direct-connection);
            box-shadow: 0 0 4px rgba(0, 255, 136, 0.5);
        }

        .legend-dot.indirect {
            background: var(--indirect-connection);
            border-color: var(--indirect-connection);
            box-shadow: 0 0 4px rgba(255, 170, 0, 0.5);
        }

        .legend-dot.none {
            background: var(--no-connection);
            border-color: var(--no-connection);
        }

        .legend-item span {
            font-size: 0.65rem;
            line-height: 1.2;
        }

        .node text {
            font: 10px 'Space Grotesk', sans-serif;
            font-weight: 500;
            text-anchor: middle;
            fill: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            pointer-events: none;
        }

        .node-name {
            font-weight: 600;
            font-size: 11px;
        }

        .node-title {
            font-weight: 400;
            font-size: 9px;
            fill: var(--text-secondary);
        }

        .link {
            fill: none;
            stroke: var(--border-color);
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            transition: all 0.3s ease;
        }

        /* Highlight animations */
        .node.highlighted circle {
            stroke-width: 6px;
            filter: drop-shadow(0 0 15px currentColor);
            animation: pulse-glow 1.5s ease-in-out infinite alternate;
        }

        .link.highlighted {
            stroke: var(--accent-primary);
            stroke-opacity: 1;
            stroke-width: 3px;
            filter: drop-shadow(0 0 8px var(--accent-primary));
            animation: flow 2s ease-in-out infinite;
        }

        .node.connected circle {
            stroke-width: 5px;
            filter: drop-shadow(0 0 10px currentColor);
        }

        @keyframes pulse-glow {
            0% { 
                transform: scale(1);
                opacity: 0.8;
            }
            100% { 
                transform: scale(1.1);
                opacity: 1;
            }
        }

        @keyframes flow {
            0%, 100% { stroke-dasharray: 5, 5; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 5, 5; stroke-dashoffset: 10; }
        }

        /* Map marker animations - Simple highlight/dim effect */
        .leaflet-interactive.highlighted {
            filter: brightness(1.3) drop-shadow(0 0 8px currentColor) !important;
            stroke-width: 4 !important;
            z-index: 1000 !important;
        }

        .leaflet-interactive.dimmed {
            opacity: 0.3 !important;
            filter: grayscale(0.7) !important;
        }

        /* Smooth transitions for map markers */
        .leaflet-interactive {
            transition: opacity 0.3s ease, filter 0.3s ease, stroke-width 0.3s ease !important;
        }

        .tooltip {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            pointer-events: none;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 1200px) {
            .visualization-container {
                flex-direction: column;
            }
            
            .champions-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .search-group, .filter-group {
                min-width: 100%;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .container {
                margin: 10px;
            }
            
            .champions-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Smart Stakeholder Search</h1>
            <p>Search and explore your organizational structure</p>
        </div>

        <div class="search-section">
            <div class="search-container">
                <div class="search-group">
                    <label for="search">Search Employee</label>
                    <input type="text" id="search" placeholder="Enter name or department...">
                </div>
                
                <div class="filter-group">
                    <label for="department-filter">Department</label>
                    <select id="department-filter">
                        <option value="">All Departments</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="country-filter">Country</label>
                    <select id="country-filter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                
                <button class="search-btn" onclick="searchEmployees()">Search</button>
            </div>
        </div>

        <div class="results-section">
            <div class="visualization-wrapper hidden" id="visualization-container">
                <!-- Connection Champions Card - Full Width at Top -->
                <div class="champions-card hidden" id="champions-card">
                    <div class="champions-header">
                        <div class="champions-title">🤝 Connection Champions</div>
                    </div>
                    <div class="champions-content">
                        <div class="champions-grid" id="champions-grid">
                            <!-- Dynamic champion cards will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Team Structure - Full Width -->
                <div class="visualization-panel full-width">
                    <div class="panel-header">
                        <div class="panel-title">🏗️ Team Structure</div>
                        <div class="chart-controls">
                            <button class="control-btn" onclick="expandAll()" title="Expand All">⊞</button>
                            <button class="control-btn" onclick="collapseAll()" title="Collapse All">⊟</button>
                            <button class="control-btn" onclick="resetChart()" title="Reset View">↻</button>
                        </div>
                    </div>
                    <div id="business-opportunity-info"></div>
                    <div style="position: relative;">
                        <div id="org-chart"></div>
                        <div class="connection-legend">
                            <div class="legend-item">
                                <div class="legend-dot direct"></div>
                                <span>Direct</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot indirect"></div>
                                <span>Indirect</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot none"></div>
                                <span>None</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Geographic Distribution - Full Width -->
                <div class="visualization-panel full-width">
                    <div class="panel-header">
                        <div class="panel-title">🗺️ Geographic Distribution</div>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPerson = null;
        let map = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            
            // Add enter key support for search
            const searchInput = document.getElementById('search');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchEmployees();
                    }
                });
            }
        });

        async function loadFilters() {
            try {
                const response = await fetch('/api/filters');
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                const filters = await response.json();
                
                const deptSelect = document.getElementById('department-filter');
                const countrySelect = document.getElementById('country-filter');
                
                if (deptSelect && filters.departments) {
                    filters.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        deptSelect.appendChild(option);
                    });
                }
                
                if (countrySelect && filters.countries) {
                    filters.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading filters:', error);
                const searchSection = document.querySelector('.search-section');
                if (searchSection) {
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = '<div style="background: #ff4444; color: white; padding: 12px; border-radius: 8px; margin: 10px 0;">' +
                        '⚠️ Error loading filters. Please check if the Flask server is running.' +
                        '</div>';
                    searchSection.appendChild(errorDiv);
                }
            }
        }

        async function searchEmployees() {
            const searchInput = document.getElementById('search');
            const deptFilter = document.getElementById('department-filter');
            const countryFilter = document.getElementById('country-filter');
            
            if (!searchInput || !deptFilter || !countryFilter) {
                console.error('Search elements not found');
                return;
            }
            
            const query = searchInput.value;
            const department = deptFilter.value;
            const country = countryFilter.value;
            
            if (!query.trim() && !department && !country) {
                alert('Please enter a search term or select a filter');
                return;
            }
            
            const params = new URLSearchParams({
                q: query,
                department: department,
                country: country
            });
            
            try {
                const response = await fetch('/api/search?' + params);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                const results = await response.json();
                
                if (results.length > 0) {
                    selectPerson(results[0].name);
                } else {
                    alert('No results found. Please try a different search term.');
                }
            } catch (error) {
                console.error('Error searching:', error);
                alert('Error searching. Please check if the Flask server is running.');
            }
        }

        async function selectPerson(personName) {
            currentPerson = personName;
            document.getElementById('visualization-container').classList.remove('hidden');
            
            await loadOrgChart();
            await loadMap();
        }

        async function loadOrgChart() {
            if (!currentPerson) return;
            
            try {
                const response = await fetch('/api/hierarchy/' + encodeURIComponent(currentPerson));
                const hierarchyData = await response.json();
                
                renderOrgChart(hierarchyData);
            } catch (error) {
                console.error('Error loading hierarchy:', error);
            }
        }

        async function loadMap() {
            if (!currentPerson) return;
            
            try {
                const response = await fetch('/api/map-data/' + encodeURIComponent(currentPerson));
                const mapData = await response.json();
                
                renderMap(mapData);
            } catch (error) {
                console.error('Error loading map data:', error);
            }
        }

        let globalTreeData = null;
        let globalSvg = null;
        let globalTree = null;
        let globalRoot = null;

        function renderOrgChart(data) {
            const container = d3.select("#org-chart");
            container.selectAll("*").remove();
            
            const width = container.node().getBoundingClientRect().width;
            const height = 600;
            
            const connectionStats = analyzeBusinessOpportunities(data);
            displayBusinessOpportunityInfo(connectionStats);
            
            const representativeStats = analyzeRepresentatives(data);
            displayConnectionChampions(representativeStats);
            
            // Store global references
            globalTreeData = data;
            
            const svg = container
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            globalSvg = svg;
            
            const g = svg.append("g")
                .attr("transform", "translate(60,40)");
            
            // Create tree layout with better spacing for full width
            const tree = d3.tree()
                .size([width - 120, height - 120])
                .separation((a, b) => {
                    return (a.parent == b.parent ? 1.8 : 2.5) / a.depth;
                });
            
            globalTree = tree;
            
            // Create hierarchy and initialize collapsed state
            const root = d3.hierarchy(data);
            globalRoot = root;
            
            // Start with only first two levels expanded
            root.descendants().forEach(d => {
                d._children = d.children;
                if (d.depth >= 2) {
                    d.children = null;
                }
            });
            
            updateChart(g, root, tree);
        }

        function updateChart(g, source, tree) {
            // Compute the new tree layout
            tree(globalRoot);
            
            const nodes = globalRoot.descendants();
            const links = globalRoot.descendants().slice(1);
            
            // Update links
            const link = g.selectAll(".link")
                .data(links, d => d.id || (d.id = ++i));
            
            const linkEnter = link.enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    const o = {x: source.x0 || source.x, y: source.y0 || source.y};
                    return diagonal(o, o);
                });
            
            const linkUpdate = linkEnter.merge(link);
            
            linkUpdate.transition()
                .duration(500)
                .attr("d", d => diagonal(d, d.parent));
            
            link.exit().transition()
                .duration(500)
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // Update nodes
            const node = g.selectAll(".node")
                .data(nodes, d => d.id || (d.id = ++i));
            
            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.x0 || source.x},${source.y0 || source.y})`)
                .on("click", click);
            
            // Add circles
            nodeEnter.append("circle")
                .attr("r", 1e-6)
                .attr("class", d => {
                    const relationship = d.data.relationship_with_qt || 'None';
                    if (relationship.toLowerCase() === 'direct') return 'direct-connection';
                    if (relationship.toLowerCase() === 'indirect') return 'indirect-connection';
                    return 'no-connection';
                });
            
            // Add names
            nodeEnter.append("text")
                .attr("class", "node-name")
                .attr("dy", "2.8em")
                .attr("text-anchor", "middle")
                .text(d => {
                    const name = d.data.name;
                    return name.length > 14 ? name.substring(0, 12) + "..." : name;
                });
            
            // Add titles
            nodeEnter.append("text")
                .attr("class", "node-title")
                .attr("dy", "4em")
                .attr("text-anchor", "middle")
                .text(d => {
                    const title = d.data.position;
                    return title.length > 18 ? title.substring(0, 16) + "..." : title;
                });
            
            // Add children count for collapsed nodes
            nodeEnter.append("text")
                .attr("class", "node-children-count")
                .attr("dy", "-1.2em")
                .attr("text-anchor", "middle")
                .text(d => d._children ? `+${d._children.length}` : '');
            
            // Add tooltips
            nodeEnter.append("title")
                .text(d => {
                    const relationship = d.data.relationship_with_qt || 'None';
                    let opportunityText = '';
                    
                    if (relationship.toLowerCase() === 'direct') {
                        opportunityText = '\nHIGH PRIORITY: Direct connection';
                    } else if (relationship.toLowerCase() === 'indirect') {
                        opportunityText = '\nGOOD OPPORTUNITY: Indirect connection';
                    } else {
                        opportunityText = '\nNO KNOWN CONNECTION';
                    }
                    
                    const representative = d.data.representative_from_qt;
                    const repText = representative && representative !== 'No' && representative !== '' ? 
                        '\nCONNECT VIA: ' + representative : '';
                    
                    return d.data.name + '\n' + d.data.position + '\n' + d.data.department + 
                           '\n' + (d.data.location || '') + opportunityText + repText;
                });
            
            const nodeUpdate = nodeEnter.merge(node);
            
            // Transition nodes to their new positions
            nodeUpdate.transition()
                .duration(500)
                .attr("transform", d => `translate(${d.x},${d.y})`);
            
            // Update circle attributes
            nodeUpdate.select("circle")
                .transition()
                .duration(500)
                .attr("r", 12)
                .attr("class", d => {
                    let className = "";
                    const relationship = d.data.relationship_with_qt || 'None';
                    if (relationship.toLowerCase() === 'direct') className += 'direct-connection';
                    else if (relationship.toLowerCase() === 'indirect') className += 'indirect-connection';
                    else className += 'no-connection';
                    
                    if (d._children) className += ' has-children';
                    return className;
                });
            
            // Update children count visibility
            nodeUpdate.select(".node-children-count")
                .style("display", d => d._children ? "block" : "none")
                .text(d => d._children ? `+${d._children.length}` : '');
            
            // Remove exiting nodes
            const nodeExit = node.exit().transition()
                .duration(500)
                .attr("transform", d => `translate(${source.x},${source.y})`)
                .remove();
            
            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("fill-opacity", 1e-6);
            
            // Store old positions for transition
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
            
            // Store references for highlighting
            window.orgChartNodes = nodeUpdate;
            window.orgChartLinks = linkUpdate;
            window.orgChartData = nodes;
        }

        let i = 0;

        function diagonal(s, d) {
            return `M ${s.x} ${s.y}
                    C ${s.x} ${(s.y + d.y) / 2},
                      ${d.x} ${(s.y + d.y) / 2},
                      ${d.x} ${d.y}`;
        }

        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            
            const g = globalSvg.select("g");
            updateChart(g, d, globalTree);
        }

        function expandAll() {
            if (!globalRoot) return;
            
            globalRoot.descendants().forEach(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            
            const g = globalSvg.select("g");
            updateChart(g, globalRoot, globalTree);
        }

        function collapseAll() {
            if (!globalRoot) return;
            
            globalRoot.descendants().forEach(d => {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            
            // Keep root expanded
            if (globalRoot._children) {
                globalRoot.children = globalRoot._children;
                globalRoot._children = null;
            }
            
            const g = globalSvg.select("g");
            updateChart(g, globalRoot, globalTree);
        }

        function resetChart() {
            if (!globalRoot) return;
            
            // Reset to initial state (first 2 levels expanded)
            globalRoot.descendants().forEach(d => {
                d._children = d.children = null;
            });
            
            const root = d3.hierarchy(globalTreeData);
            globalRoot = root;
            
            root.descendants().forEach(d => {
                d._children = d.children;
                if (d.depth >= 2) {
                    d.children = null;
                }
            });
            
            const g = globalSvg.select("g");
            updateChart(g, root, globalTree);
        }d => {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            };
            
            // Keep root expanded
            if (globalRoot._children) {
                globalRoot.children = globalRoot._children;
                globalRoot._children = null;
            }
            
            updateChart(globalRoot);
            setTimeout(() => fitToView(), 700);

        function resetChart() {
            if (!globalRoot) return;
            
            // Reset to initial state (first 2 levels expanded)
            globalRoot.descendants().forEach(d => {
                d._children = d.children = null;
            });
            
            const root = d3.hierarchy(globalTreeData);
            globalRoot = root;
            
            root.descendants().forEach(d => {
                d._children = d.children;
                if (d.depth >= 2) {
                    d.children = null;
                }
            });
            
            updateChart(root);
            setTimeout(() => fitToView(), 700);
        }

        function fitToView() {
            if (!globalSvg || !globalG || !globalZoom) return;
            
            const bounds = globalG.node().getBBox();
            const fullWidth = globalSvg.attr("width");
            const fullHeight = globalSvg.attr("height");
            const width = bounds.width;
            const height = bounds.height;
            
            if (width === 0 || height === 0) return;
            
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            const scale = Math.min(fullWidth / width, fullHeight / height) * 0.8;
            
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
            
            globalSvg.transition()
                .duration(750)
                .call(globalZoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        function analyzeBusinessOpportunities(data) {
            let stats = {
                direct: 0,
                indirect: 0,
                none: 0,
                total: 0,
                highPriorityContacts: [],
                opportunities: []
            };

            function analyzeNode(node) {
                stats.total++;
                const relationship = node.relationship_with_qt || 'None';
                
                if (relationship.toLowerCase() === 'direct') {
                    stats.direct++;
                    stats.highPriorityContacts.push({
                        name: node.name,
                        position: node.position,
                        department: node.department,
                        location: node.location || 'Unknown'
                    });
                } else if (relationship.toLowerCase() === 'indirect') {
                    stats.indirect++;
                    stats.opportunities.push({
                        name: node.name,
                        position: node.position,
                        department: node.department,
                        location: node.location || 'Unknown'
                    });
                } else {
                    stats.none++;
                }

                if (node.children) {
                    node.children.forEach(analyzeNode);
                }
            }

            analyzeNode(data);
            return stats;
        }

        function displayBusinessOpportunityInfo(stats) {
            const infoContainer = document.getElementById('business-opportunity-info');
            
            let content = '';
            
            if (stats.direct > 0) {
                const plural = stats.direct > 1 ? 's' : '';
                content += '<div class="business-opportunity-banner">' +
                    '<span class="opportunity-icon">🎯</span>' +
                    '<strong>SALES OPPORTUNITY ALERT!</strong> ' +
                    'You have ' + stats.direct + ' direct connection' + plural + ' in this team - ' +
                    'Perfect for sales introductions!' +
                    '</div>';
            }
            
            if (stats.indirect > 0 && stats.direct === 0) {
                const plural = stats.indirect > 1 ? 's' : '';
                content += '<div class="business-opportunity-banner">' +
                    '<span class="opportunity-icon">💼</span>' +
                    '<strong>BUSINESS DEVELOPMENT OPPORTUNITY!</strong> ' +
                    stats.indirect + ' indirect connection' + plural + ' found - ' +
                    'Consider warm introductions for sales outreach.' +
                    '</div>';
            }
            
            infoContainer.innerHTML = content;
        }

        function analyzeRepresentatives(data) {
            const representatives = {};
            
            function analyzeNode(node) {
                const representative = node.representative_from_qt;
                if (representative && representative !== 'No' && representative !== '' && representative !== 'N/A') {
                    if (!representatives[representative]) {
                        representatives[representative] = {
                            name: representative,
                            connections: [],
                            totalConnections: 0,
                            directConnections: 0,
                            indirectConnections: 0
                        };
                    }
                    
                    const relationship = node.relationship_with_qt || 'None';
                    if (relationship.toLowerCase() === 'direct') {
                        representatives[representative].directConnections++;
                    } else if (relationship.toLowerCase() === 'indirect') {
                        representatives[representative].indirectConnections++;
                    }
                    
                    representatives[representative].connections.push({
                        name: node.name,
                        position: node.position,
                        department: node.department,
                        location: node.location || 'Unknown',
                        relationship: relationship
                    });
                    representatives[representative].totalConnections++;
                }

                if (node.children) {
                    node.children.forEach(analyzeNode);
                }
            }

            analyzeNode(data);
            
            return Object.values(representatives).sort((a, b) => b.totalConnections - a.totalConnections);
        }

        function displayConnectionChampions(representatives) {
            const championsCard = document.getElementById('champions-card');
            const championsGrid = document.getElementById('champions-grid');
            
            if (representatives.length === 0) {
                championsCard.classList.add('hidden');
                return;
            }
            
            championsCard.classList.remove('hidden');
            championsGrid.innerHTML = '';
            
            representatives.forEach(rep => {
                const initials = rep.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const championCard = document.createElement('div');
                championCard.className = 'champion-card';
                championCard.onclick = () => highlightChampionConnections(rep);
                
                let badges = '';
                if (rep.directConnections > 0) {
                    badges += `<span class="connection-badge badge-direct">${rep.directConnections} Direct</span>`;
                }
                if (rep.indirectConnections > 0) {
                    badges += `<span class="connection-badge badge-indirect">${rep.indirectConnections} Indirect</span>`;
                }
                
                championCard.innerHTML = `
                    <div class="champion-avatar">${initials}</div>
                    <div class="champion-name">${rep.name}</div>
                    <div class="champion-connections">${rep.totalConnections} Connections</div>
                    <div class="champion-breakdown">${badges}</div>
                `;
                
                championsGrid.appendChild(championCard);
            });
        }

        function highlightChampionConnections(champion) {
            // Clear any existing highlights
            clearHighlights();
            
            // Highlight in org chart
            if (window.orgChartNodes && window.orgChartData) {
                window.orgChartNodes.each(function(d) {
                    const representative = d.data.representative_from_qt;
                    if (representative === champion.name) {
                        d3.select(this).classed('highlighted', true);
                        
                        // Find and highlight the path to this node
                        highlightPathToNode(d);
                    }
                });
            }
            
            // Highlight in map
            highlightChampionOnMap(champion);
            
            // Auto-clear highlights after 20 seconds
            setTimeout(clearHighlights, 20000);
        }

        function highlightPathToNode(targetNode) {
            if (!window.orgChartLinks) return;
            
            // Get all ancestors of the target node
            const ancestors = targetNode.ancestors();
            const ancestorNames = ancestors.map(d => d.data.name);
            
            // Highlight all nodes in the path
            window.orgChartNodes.each(function(d) {
                if (ancestorNames.includes(d.data.name)) {
                    d3.select(this).classed('connected', true);
                }
            });
            
            // Highlight links in the path
            window.orgChartLinks.each(function(d) {
                if (ancestorNames.includes(d.data.name) && ancestorNames.includes(d.parent.data.name)) {
                    d3.select(this).classed('highlighted', true);
                }
            });
        }

        function highlightChampionOnMap(champion) {
            if (!map) return;
            
            // Find locations where this champion has connections
            const championLocations = [];
            champion.connections.forEach(connection => {
                if (!championLocations.includes(connection.location)) {
                    championLocations.push(connection.location);
                }
            });
            
            // Apply highlight/dim effect to markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.CircleMarker) {
                    const popup = layer.getPopup();
                    const element = layer.getElement();
                    
                    if (popup && element) {
                        const content = popup.getContent();
                        let isHighlighted = false;
                        
                        // Check if this marker should be highlighted
                        championLocations.forEach(location => {
                            if (content.includes(location)) {
                                isHighlighted = true;
                            }
                        });
                        
                        if (isHighlighted) {
                            element.classList.add('highlighted');
                            element.classList.remove('dimmed');
                        } else {
                            element.classList.add('dimmed');
                            element.classList.remove('highlighted');
                        }
                    }
                }
            });
        }

        function clearHighlights() {
            // Clear org chart highlights
            if (window.orgChartNodes) {
                window.orgChartNodes.classed('highlighted connected', false);
            }
            if (window.orgChartLinks) {
                window.orgChartLinks.classed('highlighted', false);
            }
            
            // Clear map highlights - restore all markers to normal state
            if (map) {
                map.eachLayer(function(layer) {
                    if (layer instanceof L.CircleMarker) {
                        const element = layer.getElement();
                        if (element) {
                            element.classList.remove('highlighted', 'dimmed');
                        }
                    }
                });
            }
        }

        function renderMap(mapData) {
            if (map) {
                map.remove();
            }
            
            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                dragging: false
            }).setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            const locationCoords = {
                'New York': [40.7128, -74.0060],
                'San Francisco': [37.7749, -122.4194],
                'Chicago': [41.8781, -87.6298],
                'Austin': [30.2672, -97.7431],
                'Seattle': [47.6062, -122.3321],
                'Denver': [39.7392, -104.9903],
                'London': [51.5074, -0.1278],
                'Manchester': [53.4808, -2.2426],
                'Berlin': [52.5200, 13.4050],
                'Munich': [48.1351, 11.5820],
                'Hamburg': [53.5511, 9.9937],
                'Lisbon': [38.7223, -9.1393],
                'Porto': [41.1579, -8.6291],
                'Braga': [41.5518, -8.4229],
                'Mumbai': [19.0760, 72.8777],
                'Bangalore': [12.9716, 77.5946],
                'Delhi': [28.7041, 77.1025],
                'Chennai': [13.0827, 80.2707],
                'Pune': [18.5204, 73.8567],
                'Tokyo': [35.6762, 139.6503],
                'Sydney': [-33.8688, 151.2093],
                'Madrid': [40.4168, -3.7038],
                'Toronto': [43.6532, -79.3832],
                'Vancouver': [49.2827, -123.1207],
                'Amsterdam': [52.3676, 4.9041],
                'São Paulo': [-23.5505, -46.6333],
                'Rio de Janeiro': [-22.9068, -43.1729],
                'Paris': [48.8566, 2.3522],
                'Lyon': [45.7640, 4.8357],
                'Nice': [43.7102, 7.2620],
                'Dubai': [25.2048, 55.2708],
                'Stockholm': [59.3293, 18.0686],
                'Milan': [45.4642, 9.1900],
                'Dublin': [53.3498, -6.2603],
                'Warsaw': [52.2297, 21.0122],
                'Santiago': [-33.4489, -70.6693],
                'Beijing': [39.9042, 116.4074],
                'Shanghai': [31.2304, 121.4737],
                'Singapore': [1.3521, 103.8198],
                'Kyoto': [35.0116, 135.7681],
                'Osaka': [34.6937, 135.5023],
                'Washington DC': [38.9072, -77.0369],
                'Boston': [42.3601, -71.0589],
                'Atlanta': [33.7490, -84.3880],
                'Portland': [45.5152, -122.6784],
                'Miami': [25.7617, -80.1918],
                'Melbourne': [-37.8136, 144.9631],
                'Frankfurt': [50.1109, 8.6821],
                'Cologne': [50.9375, 6.9603],
                'Coimbra': [40.2033, -8.4103],
                'Birmingham': [52.4862, -1.8904],
                'Edinburgh': [55.9533, -3.1883],
                'Hyderabad': [17.3850, 78.4867]
            };
            
            mapData.forEach(location => {
                const coords = locationCoords[location.location] || [0, 0];
                
                if (coords[0] !== 0 || coords[1] !== 0) {
                    const connectionCounts = {
                        direct: 0,
                        indirect: 0,
                        none: 0
                    };
                    
                    location.people.forEach(person => {
                        const relationship = person.relationship_with_qt || 'None';
                        if (relationship.toLowerCase() === 'direct') {
                            connectionCounts.direct++;
                        } else if (relationship.toLowerCase() === 'indirect') {
                            connectionCounts.indirect++;
                        } else {
                            connectionCounts.none++;
                        }
                    });
                    
                    let circleColor, strokeColor;
                    if (connectionCounts.direct > 0) {
                        circleColor = '#00ff88';
                        strokeColor = '#00cc6a';
                    } else if (connectionCounts.indirect > 0) {
                        circleColor = '#ffaa00';
                        strokeColor = '#cc8800';
                    } else {
                        circleColor = '#666666';
                        strokeColor = '#444444';
                    }
                    
                    const circleMarker = L.circleMarker(coords, {
                        radius: 20,
                        fillColor: circleColor,
                        color: strokeColor,
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    const popupContent = '<div style="font-family: \'Space Grotesk\', sans-serif; min-width: 250px;">' +
                        '<h3 style="margin: 0 0 12px 0; color: #333; font-size: 1.1rem;">📍 ' + location.location + '</h3>' +
                        '<p style="margin: 0 0 10px 0; font-weight: 600; color: #555;"><strong>Total Employees:</strong> ' + location.count + '</p>' +
                        
                        (connectionCounts.direct > 0 ? 
                            '<div style="background: #e8f5e8; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #00ff88;">' +
                            '<strong style="color: #00aa55;">🤝 Direct Connections: ' + connectionCounts.direct + '</strong>' +
                            '<br><small style="color: #007733;">High priority sales opportunities!</small></div>' : '') +
                        
                        (connectionCounts.indirect > 0 ? 
                            '<div style="background: #fff8e1; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ffaa00;">' +
                            '<strong style="color: #cc8800;">🔗 Indirect Connections: ' + connectionCounts.indirect + '</strong>' +
                            '<br><small style="color: #996600;">Good networking opportunities!</small></div>' : '') +
                        
                        (connectionCounts.none > 0 ? 
                            '<div style="background: #f5f5f5; padding: 8px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #666666;">' +
                            '<strong style="color: #666;">❌ No Known Connections: ' + connectionCounts.none + '</strong></div>' : '') +
                        
                        '<div style="max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 8px;">' +
                        '<strong style="color: #333; font-size: 0.9rem;">Team Members:</strong>' +
                        '<ul style="margin: 6px 0 0 0; padding-left: 16px; font-size: 0.85rem;">' +
                        location.people.map(person => {
                            const relationship = person.relationship_with_qt || 'None';
                            let connectionIcon = '';
                            let textColor = '#333';
                            
                            if (relationship.toLowerCase() === 'direct') {
                                connectionIcon = '🤝';
                                textColor = '#00aa55';
                            } else if (relationship.toLowerCase() === 'indirect') {
                                connectionIcon = '🔗';
                                textColor = '#cc8800';
                            } else {
                                connectionIcon = '❌';
                                textColor = '#666';
                            }
                            
                            return '<li style="margin-bottom: 4px; color: ' + textColor + ';">' +
                                connectionIcon + ' <strong>' + person.name + '</strong><br>' +
                                '<small style="color: #666;">' + person.position + '</small>' +
                                (person.representative_from_qt && person.representative_from_qt !== 'No' && person.representative_from_qt !== '' ? 
                                    '<br><small style="color: #4a90e2;">🔗 Via: ' + person.representative_from_qt + '</small>' : '') +
                                '</li>';
                        }).join('') +
                        '</ul></div></div>';
                    
                    circleMarker.bindPopup(popupContent);
                }
            });
            
            setTimeout(() => {
                map.setView([20, 0], 2);
            }, 100);
        }
    </script>
</body>
</html>